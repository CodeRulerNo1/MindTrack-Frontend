<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Simple checkmark style for custom checkbox */
        .custom-checkbox:checked {
            background-color: #3b82f6; /* bg-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        .custom-checkbox:checked::before {
            content: 'âœ”';
            color: white;
            font-size: 1.25rem;
            line-height: 1.5rem;
            display: block;
            text-align: center;
            width: 1.5rem;
            height: 1.5rem;
        }
        /* Hide sections by default */
        #calendar-view { display: none; }

        /* Simple spinning loader for when data is loading */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-sm p-6 mt-10 bg-white rounded-2xl shadow-lg min-h-[600px]">

        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-blue-600">MindTrack</h1>
            <p class="text-lg text-gray-500 mt-1" id="subtitle">Log your daily habits</p>
        </div>

        <div class="flex w-full rounded-lg bg-gray-200 p-1 mb-6">
            <button id="show-log-btn" class="w-1/2 py-2 text-center font-semibold text-white bg-blue-600 rounded-md shadow">Log Habits</button>
            <button id="show-calendar-btn" class="w-1/2 py-2 text-center font-semibold text-gray-600">Calendar & Stats</button>
        </div>

        <div id="log-view">
            
            <div class="text-center p-4 mb-4 bg-blue-50 border-l-4 border-blue-400 rounded-md shadow-sm min-h-[60px] flex items-center justify-center">
                <p class="text-lg text-blue-800" id="motivation-quote">Loading your daily motivation...</p>
            </div>

            <div class="space-y-4" id="habit-list-container">
                <div class="loader" id="habit-list-loader"></div>
            </div>

            <div class="mt-8">
                <label for="new-habit-input" class="block text-md font-semibold text-gray-700 mb-2">Add a Custom Habit</label>
                <div class="flex gap-2">
                    <input type="text" id="new-habit-input" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Meditate for 10 mins">
                    <button id="add-habit-btn" class="py-3 px-5 bg-gray-700 text-white text-md font-semibold rounded-lg shadow-sm transition-all hover:bg-gray-800 active:scale-[.98]">
                        Add
                    </button>
                </div>
            </div>

            <button id="log-button" class="w-full mt-8 py-3 px-4 bg-blue-600 text-white text-xl font-semibold rounded-lg shadow-md transition-all hover:bg-blue-700 active:scale-[.98]">
                Log Progress
            </button>

            <div id="status-label" class="text-center mt-4 h-6 text-lg">
                </div>
        </div>

        <div id="calendar-view">
            
            <div class="grid grid-cols-4 gap-2 mb-6 text-center">
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-blue-600" id="stat-streak">0</span>
                        <span id="stat-streak-emoji">ðŸ˜”</span>
                    </div>
                    <p class="text-sm text-gray-500">Current Streak</p>
                </div>
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800" id="stat-total-days">0</span>
                    </div>
                    <p class="text-sm text-gray-500">Total Days</p>
                </div>
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800" id="stat-total-habits">0</span>
                    </div>
                    <p class="text-sm text-gray-500">Total Habits</p>
                </div>
                <div>
                    <div class="text-xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800 break-words" id="stat-best-habit">-</span>
                    </div>
                    <p class="text-sm text-gray-500">Best Habit</p>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800" id="calendar-month-year"></h2>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-500">
                <div>Sun</div> <div>Mon</div> <div>Tue</div> <div>Wed</div> <div>Thu</div> <div>Fri</div> <div>Sat</div>
            </div>
            <div class="grid grid-cols-7 gap-1 mt-2" id="calendar-days-grid">
                <div class="loader" id="calendar-loader"></div>
            </div>
            <p class="text-sm text-center text-gray-500 mt-4">Days you logged habits are marked in green.</p>

            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-700 text-center">Need a new challenge?</h3>
                <p class="text-sm text-gray-500 text-center mb-4">Let our AI suggest a new habit based on your progress.</p>
                
                <button id="suggest-habit-btn" class="w-full py-2 px-4 bg-gray-600 text-white text-md font-semibold rounded-lg shadow-sm transition-all hover:bg-gray-700 active:scale-[.98]">
                    Suggest a New Habit
                </button>

                <div id="suggestion-box" class="text-center mt-4 p-4 h-20 bg-gray-50 rounded-lg border border-dashed border-gray-300 flex items-center justify-center">
                    <p id="suggestion-text" class="text-gray-500 italic">Click the button to get an idea!</p>
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- Globals ---
        // !!! IMPORTANT: This MUST be your live Render URL !!!
        const BACKEND_URL = 'https_://mindtrack-backend.onrender.com'; // <--- Make sure this is your URL!
        
        let allHabitLogs = {}; // Stores { "2025-10-25": ["water"], ... }
        let userHabits = [];   // Stores [{id: 1, name: 'water', is_deletable: 0}, ...]

        // --- Element Refs ---
        const logButton = document.getElementById('log-button');
        const statusLabel = document.getElementById('status-label');
        const habitListContainer = document.getElementById('habit-list-container');
        const habitListLoader = document.getElementById('habit-list-loader');
        const newHabitInput = document.getElementById('new-habit-input');
        const addHabitBtn = document.getElementById('add-habit-btn');
        
        // View Toggling Refs
        const logView = document.getElementById('log-view');
        const calendarView = document.getElementById('calendar-view');
        const showLogBtn = document.getElementById('show-log-btn');
        const showCalendarBtn = document.getElementById('show-calendar-btn');
        const subtitle = document.getElementById('subtitle');
        
        // Calendar & Stats Refs
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarDaysGrid = document.getElementById('calendar-days-grid');
        const calendarLoader = document.getElementById('calendar-loader');
        const statStreak = document.getElementById('stat-streak');
        const statTotalDays = document.getElementById('stat-total-days');
        const statBestHabit = document.getElementById('stat-best-habit');
        const statTotalHabits = document.getElementById('stat-total-habits'); 
        const statStreakEmoji = document.getElementById('stat-streak-emoji'); 

        // Motivation Ref
        const motivationQuote = document.getElementById('motivation-quote');

        // AI Suggestion Refs
        const suggestHabitBtn = document.getElementById('suggest-habit-btn');
        const suggestionText = document.getElementById('suggestion-text');

        // --- Utility ---
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // --- Data Fetching ---
        
        /**
         * Fetches all essential data when the app loads.
         * Renders the UI once all data is available.
         */
        async function loadApp() {
            try {
                // Fetch all data in parallel
                const [habitsResponse, todayLogsResponse, motivationResponse] = await Promise.all([
                    fetch(`${BACKEND_URL}/get_habits`),
                    fetch(`${BACKEND_URL}/get_today_logs`),
                    fetch(`${BACKEND_URL}/get_motivation`)
                ]);

                if (!habitsResponse.ok) throw new Error('Failed to fetch habits');
                if (!todayLogsResponse.ok) throw new Error('Failed to fetch today\'s logs');
                if (!motivationResponse.ok) throw new Error('Failed to fetch motivation');

                userHabits = await habitsResponse.json();
                const todayLogs = await todayLogsResponse.json(); // e.g., ["water", "reading"]
                const motivationData = await motivationResponse.json();

                // Render the app components
                motivationQuote.textContent = motivationData.message;
                renderHabitList(todayLogs);

            } catch (error) {
                console.error('Error loading app:', error);
                habitListContainer.innerHTML = `<p class="text-red-600 text-center">Error: Could not connect to backend. Is it running?</p>`;
                motivationQuote.textContent = "Could not load data. Please refresh.";
            }
        }

        /**
         * Fetches all data needed for the Calendar & Stats view.
         */
        async function fetchCalendarAndStats() {
            calendarLoader.style.display = 'block'; // Show loader
            calendarDaysGrid.innerHTML = ''; // Clear old grid
            
            try {
                // Fetch stats and all-time logs in parallel
                const [statsResponse, allLogsResponse] = await Promise.all([
                    fetch(`${BACKEND_URL}/get_stats`),
                    fetch(`${BACKEND_URL}/get_logs`)
                ]);
                
                if (!statsResponse.ok) throw new Error('Failed to fetch stats');
                if (!allLogsResponse.ok) throw new Error('Failed to fetch logs');

                const stats = await statsResponse.json();
                allHabitLogs = await allLogsResponse.json();

                // Populate stats
                statStreak.textContent = stats.current_streak;
                statStreakEmoji.textContent = stats.streak_emoji; 
                statTotalDays.textContent = stats.total_days;
                statTotalHabits.textContent = stats.total_habits_completed; 
                
                // --- THIS IS THE CHANGE ---
                // Takes "Read for 20 minutes" and turns it into "Read"
                statBestHabit.textContent = stats.best_habit.split(' ')[0];

                // Render calendar
                renderCalendar();

            } catch (error) {
                console.error('Error fetching calendar/stats:', error);
                calendarDaysGrid.innerHTML = `<p class="text-red-600 text-center col-span-7">Error loading calendar data.</p>`;
            } finally {
                calendarLoader.style.display = 'none'; // Hide loader
            }
        }
        
        /**
         * Fetches an AI-driven habit suggestion.
         */
        async function fetchSuggestion() {
            suggestionText.textContent = 'Thinking...';
            suggestionText.className = 'text-gray-500 italic';

            // Get the list of habits the user is *already* tracking
            const currentHabitNames = userHabits.map(h => h.name.toLowerCase());

            try {
                const response = await fetch(`${BACKEND_URL}/get_suggestion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_habits: currentHabitNames })
                });

                if (!response.ok) throw new Error('Failed to get suggestion');
                
                const data = await response.json();
                
                // Display the suggestion
                suggestionText.textContent = data.suggestion;
                suggestionText.className = 'text-blue-600 font-semibold text-lg';

            } catch (error) {
                console.error('Error fetching suggestion:', error);
                suggestionText.textContent = 'Error getting suggestion. Try again!';
                suggestionText.className = 'text-red-600 italic';
            }
        }
        
        // --- Data Posting ---

        /**
         * Sends the currently checked habits to the backend.
         */
        async function logHabits() {
            const completedHabits = [];
            // Find all checkboxes that are currently in the DOM
            document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    completedHabits.push(checkbox.getAttribute('data-habit-name'));
                }
            });

            console.log('Logging habits:', completedHabits);
            statusLabel.textContent = 'Logging...';
            statusLabel.className = 'text-center mt-4 h-6 text-lg text-gray-500';

            try {
                const response = await fetch(`${BACKEND_URL}/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ habits: completedHabits })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                console.log('Backend response:', data);
                statusLabel.textContent = 'Logged successfully!';
                statusLabel.className = 'text-center mt-4 h-6 text-lg text-green-600';
                
                // After successful log, re-fetch motivation (streak might have changed)
                try {
                    const motivationResponse = await fetch(`${BACKEND_URL}/get_motivation`);
                    if (motivationResponse.ok) {
                        const motivationData = await motivationResponse.json();
                        motivationQuote.textContent = motivationData.message;
                    }
                } catch (motivationError) {
                    console.error("Failed to re-fetch motivation:", motivationError);
                    // Don't show a big error, just let the log success message stand
                }

            } catch (error) {
                console.error('Error logging habits:', error);
                statusLabel.textContent = 'Error: Backend is offline.';
                statusLabel.className = 'text-center mt-4 h-6 text-lg text-red-600';
            }

            setTimeout(() => { statusLabel.textContent = ''; }, 3000);
        }

        /**
         * Adds a new custom habit.
         */
        async function addHabit() {
            const habitName = newHabitInput.value.trim();
            if (!habitName) {
                alert('Please enter a habit name.');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/add_habit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: habitName })
                });

                if (!response.ok) throw new Error('Failed to add habit');

                // Success! Refetch the habit list and rerender it
                userHabits = await response.json();
                renderHabitList([]); // Rerender, don't worry about checks
                newHabitInput.value = ''; // Clear input

            } catch (error) {
                console.error('Error adding habit:', error);
                alert('Error adding habit. Please try again.');
            }
        }

        /**
         * Deletes a custom habit.
         */
        async function deleteHabit(habitId) {
            if (!confirm('Are you sure you want to delete this habit?')) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/delete_habit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: habitId })
                });

                if (!response.ok) throw new Error('Failed to delete habit');

                // Success! Refetch the habit list and rerender it
                userHabits = await response.json();
                renderHabitList([]); // Rerender, don't worry about checks

            } catch (error) {
                console.error('Error deleting habit:', error);
                alert('Error deleting habit. Please try again.');
            }
        }


        // --- View Rendering ---
        
        /**
         * Builds the HTML for the habit list dynamically.
         * @param {string[]} todayLogs - A list of habit names logged today.
         */
        function renderHabitList(todayLogs) {
            habitListContainer.innerHTML = ''; // Clear loader or old list
            
            if (userHabits.length === 0) {
                 habitListContainer.innerHTML = `<p class="text-gray-500 text-center">No habits added yet. Add one below!</p>`;
                 return;
            }

            userHabits.forEach(habit => {
                const isChecked = todayLogs.includes(habit.name);

                const habitElement = document.createElement('label');
                habitElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm cursor-pointer transition-all hover:shadow-md';
                
                let deleteButtonHTML = '';
                if (habit.is_deletable) {
                    deleteButtonHTML = `<button data-habit-id="${habit.id}" class="delete-habit-btn text-red-400 font-bold text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100">&times;</button>`;
                }

                habitElement.innerHTML = `
                    <span class="text-lg text-gray-800">${habit.name}</span>
                    <div class="flex items-center gap-2">
                        ${deleteButtonHTML}
                        <input type="checkbox" data-habit-name="${habit.name}" class="custom-checkbox habit-checkbox appearance-none w-6 h-6 border-2 border-gray-300 rounded-md transition-all" ${isChecked ? 'checked' : ''}>
                    </div>
                `;
                
                habitListContainer.appendChild(habitElement);
            });

            // Add event listeners to the new delete buttons
            document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); // Stop label from toggling checkbox
                    e.stopPropagation();
                    const habitId = e.target.getAttribute('data-habit-id');
                    deleteHabit(habitId);
                });
            });
        }

        /**
         * Renders the calendar grid for the current month.
         */
        function renderCalendar() {
            const today = new Date(); 
            const month = today.getMonth(); 
            const year = today.getFullYear();

            calendarMonthYear.textContent = today.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            calendarDaysGrid.innerHTML = ''; // Clear loader

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarDaysGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'w-10 h-10 flex items-center justify-center rounded-full';
                dayDiv.textContent = day;
                
                const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (allHabitLogs[dayString] && allHabitLogs[dayString].length > 0) {
                    dayDiv.classList.add('bg-green-200', 'text-green-800', 'font-bold');
                }

                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayDiv.classList.add(allHabitLogs[dayString] ? 'bg-green-600' : 'bg-blue-600', 'text-white');
                }
                
                calendarDaysGrid.appendChild(dayDiv);
            }
        }

        /**
         * Toggles between the "Log Habits" and "Calendar & Stats" views.
         */
        function toggleView(showView) {
            if (showView === 'log') {
                logView.style.display = 'block';
                calendarView.style.display = 'none';
                subtitle.textContent = 'Log your daily habits';
                showLogBtn.className = 'w-1/2 py-2 text-center font-semibold text-white bg-blue-600 rounded-md shadow';
                showCalendarBtn.className = 'w-1/2 py-2 text-center font-semibold text-gray-600';
            } else {
                logView.style.display = 'none';
                calendarView.style.display = 'block';
                subtitle.textContent = 'Your progress & stats';
                showLogBtn.className = 'w-1/2 py-2 text-center font-semibold text-gray-600';
                showCalendarBtn.className = 'w-1/2 py-2 text-center font-semibold text-white bg-blue-600 rounded-md shadow';
                
                // Fetch fresh calendar/stats data *every time* user clicks this tab
                fetchCalendarAndStats();
            }
        }

        // --- Event Listeners ---
        logButton.addEventListener('click', logHabits);
        addHabitBtn.addEventListener('click', addHabit);
        showLogBtn.addEventListener('click', () => toggleView('log'));
        showCalendarBtn.addEventListener('click', () => toggleView('calendar'));
        suggestHabitBtn.addEventListener('click', fetchSuggestion);

        // --- Initial Load ---
        // Start the app by loading all essential data
        loadApp();

    </script>

</body>
</html>

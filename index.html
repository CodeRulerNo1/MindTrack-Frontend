<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::before { content: '‚úî'; color: white; font-size: 1.25rem; line-height: 1.5rem; display: block; text-align: center; width: 1.5rem; height: 1.5rem; }
        #calendar-view, #friend-view { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .tab-inactive { color: #4b5563; }
        /* Style for the character image */
        #character-img { width: 40px; height: 40px; margin-right: 12px; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-sm p-6 mt-10 bg-white rounded-2xl shadow-lg min-h-[600px]">

        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-blue-600">MindTrack</h1>
            <p class="text-lg text-gray-500 mt-1" id="subtitle">Log your daily habits</p>
        </div>

        <div class="flex w-full rounded-lg bg-gray-200 p-1 mb-6">
            <button id="show-log-btn" class="w-1/3 py-2 text-center font-semibold tab-active rounded-md">Log</button>
            <button id="show-calendar-btn" class="w-1/3 py-2 text-center font-semibold tab-inactive rounded-md">Stats</button>
            <button id="show-friend-btn" class="w-1/3 py-2 text-center font-semibold tab-inactive rounded-md">Friends</button>
        </div>

        <div id="log-view">
            <div class="text-left p-4 mb-4 bg-blue-50 border-l-4 border-blue-400 rounded-md shadow-sm min-h-[60px] flex items-center">
                <img id="character-img" src="" alt="Character"> 
                <p class="text-lg text-blue-800" id="motivation-quote">Loading...</p>
            </div>
            <div class="space-y-4" id="habit-list-container">
                <div class="loader" id="habit-list-loader"></div>
            </div>
            <div class="mt-8">
                <label for="new-habit-input" class="block text-md font-semibold text-gray-700 mb-2">Add a Custom Habit</label>
                <div class="flex gap-2">
                    <input type="text" id="new-habit-input" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Meditate for 10 mins">
                    <button id="add-habit-btn" class="py-3 px-5 bg-gray-700 text-white text-md font-semibold rounded-lg shadow-sm transition-all hover:bg-gray-800 active:scale-[.98]">Add</button>
                </div>
            </div>
            <button id="log-button" class="w-full mt-8 py-3 px-4 bg-blue-600 text-white text-xl font-semibold rounded-lg shadow-md transition-all hover:bg-blue-700 active:scale-[.98]">Log Progress</button>
            <div id="status-label" class="text-center mt-4 h-6 text-lg"></div>
        </div>

        <div id="calendar-view">
           <div class="grid grid-cols-4 gap-2 mb-6 text-center">
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-blue-600" id="stat-streak">0</span>
                        <span id="stat-streak-emoji">üòî</span>
                    </div>
                    <p class="text-sm text-gray-500">Current Streak</p>
                </div>
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800" id="stat-total-days">0</span>
                    </div>
                    <p class="text-sm text-gray-500">Total Days</p>
                </div>
                <div>
                    <div class="text-3xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800" id="stat-total-habits">0</span>
                    </div>
                    <p class="text-sm text-gray-500">Total Habits</p>
                </div>
                <div>
                    <div class="text-xl h-10 flex items-center justify-center">
                        <span class="font-bold text-gray-800 break-words" id="stat-best-habit">-</span>
                    </div>
                    <p class="text-sm text-gray-500">Best Habit</p>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800" id="calendar-month-year"></h2>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-500">
                <div>Sun</div> <div>Mon</div> <div>Tue</div> <div>Wed</div> <div>Thu</div> <div>Fri</div> <div>Sat</div>
            </div>
            <div class="grid grid-cols-7 gap-1 mt-2" id="calendar-days-grid">
                <div class="loader" id="calendar-loader"></div>
            </div>
        </div>
        
        <div id="friend-view">
             <div class="mb-6">
                <label class="block text-md font-semibold text-gray-700 mb-2">Share Your ID With Friends!</label>
                <div class="flex gap-2">
                    <input type="text" id="your-user-id" class="flex-grow p-3 bg-gray-100 border border-gray-300 rounded-lg shadow-sm" readonly>
                    <button id="copy-id-btn" class="py-3 px-5 bg-gray-700 text-white text-md font-semibold rounded-lg shadow-sm transition-all hover:bg-gray-800 active:scale-[.98]">Copy</button>
                </div>
            </div>
            <div class="mb-4 border-t pt-6">
                <label for="friend-id-input" class="block text-md font-semibold text-gray-700 mb-2">Check a Friend's Progress</label>
                <div class="flex gap-2">
                    <input type="text" id="friend-id-input" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste friend's ID">
                    <button id="search-friend-btn" class="py-3 px-5 bg-blue-600 text-white text-md font-semibold rounded-lg shadow-sm transition-all hover:bg-blue-700 active:scale-[.98]">Load</button>
                </div>
            </div>
            <div id="friend-stats-display" class="text-center p-4 h-32 bg-gray-50 rounded-lg border border-dashed border-gray-300 flex items-center justify-center">
                <p class="text-gray-500 italic">Search for a friend to see their stats!</p>
            </div>
        </div>

    </div>

    <script>
        // --- Globals ---
        const BACKEND_URL = 'https://mindtrack-backend-5wpc.onrender.com'; // Your Render URL
        let userHabits = [];
        let allHabitLogs = {};
        let userId = localStorage.getItem('mindtrack_userId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substring(2, 11);
            localStorage.setItem('mindtrack_userId', userId);
        }
        console.log("Current User ID:", userId);
        
        // --- NEW: Image URLs based on emoji ---
        // !!! REPLACE THESE WITH YOUR ACTUAL GITHUB IMAGE URLS !!!
        const CHARACTER_IMAGES = {
            'üòî': 'https://raw.githubusercontent.com/CodeRulerNo1/MindTrack-Frontend/blob/main/img/New%20Project%20.png', // Replace
            'üòä': 'https://raw.githubusercontent.com/CodeRulerNo1/MindTrack-Frontend/blob/main/img/New%20Project%20(1).png', // Replace
            'üî•': 'https://raw.githubusercontent.com/CodeRulerNo1/MindTrack-Frontend/blob/main/img/New%20Project%20(2).png', // Replace
            'üèÜ': 'https://raw.githubusercontent.com/CodeRulerNo1/MindTrack-Frontend/blob/main/img/New%20Project%20(3).png', // Replace
            'default': 'https://raw.githubusercontent.com/CodeRulerNo1/MindTrack-Frontend/blob/main/img/New%20Project%20(1).png' // Fallback - Replace
        };

        // --- Element Refs ---
        // (No changes needed here)
        const logButton = document.getElementById('log-button');
        const statusLabel = document.getElementById('status-label');
        const habitListContainer = document.getElementById('habit-list-container');
        const habitListLoader = document.getElementById('habit-list-loader');
        const newHabitInput = document.getElementById('new-habit-input');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const subtitle = document.getElementById('subtitle');
        const motivationQuote = document.getElementById('motivation-quote');
        const characterImg = document.getElementById('character-img'); // <-- NEW Ref

        // View Toggling Refs
        const logView = document.getElementById('log-view');
        const calendarView = document.getElementById('calendar-view');
        const friendView = document.getElementById('friend-view');
        const showLogBtn = document.getElementById('show-log-btn');
        const showCalendarBtn = document.getElementById('show-calendar-btn');
        const showFriendBtn = document.getElementById('show-friend-btn');

        // Calendar & Stats Refs
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarDaysGrid = document.getElementById('calendar-days-grid');
        const calendarLoader = document.getElementById('calendar-loader');
        const statStreak = document.getElementById('stat-streak');
        const statTotalDays = document.getElementById('stat-total-days');
        const statBestHabit = document.getElementById('stat-best-habit');
        const statTotalHabits = document.getElementById('stat-total-habits');
        const statStreakEmoji = document.getElementById('stat-streak-emoji');

        // Friends Refs
        const yourUserIdInput = document.getElementById('your-user-id');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const friendIdInput = document.getElementById('friend-id-input');
        const searchFriendBtn = document.getElementById('search-friend-btn');
        const friendStatsDisplay = document.getElementById('friend-stats-display');

        // --- API Helper ---
        async function fetchApi(endpoint, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['X-User-Id'] = userId;
            if (options.body && !options.headers['Content-Type']) {
                options.headers['Content-Type'] = 'application/json';
            }
            const response = await fetch(BACKEND_URL + endpoint, options);
            if (!response.ok) {
                const errorData = await response.json();
                console.error('API Error:', errorData);
                throw new Error(errorData.error || 'API request failed');
            }
            return response.json();
        }

        // --- Data Fetching ---
        
        /**
         * Fetches all essential data when the app loads.
         * Includes stats now to get the emoji for the character image.
         */
        async function loadApp() {
            try {
                // Fetch habits, today's logs, motivation, AND stats
                const [habits, todayLogs, motivationData, stats] = await Promise.all([
                    fetchApi('/get_habits'),
                    fetchApi('/get_today_logs'),
                    fetchApi('/get_motivation'),
                    fetchApi('/get_stats') // <-- Fetch stats too
                ]);

                userHabits = habits;
                
                // Update motivation quote
                motivationQuote.textContent = motivationData.message;
                
                // Update character image based on streak emoji
                const emoji = stats.streak_emoji || 'default';
                characterImg.src = CHARACTER_IMAGES[emoji] || CHARACTER_IMAGES['default'];
                
                // Render the habit list
                renderHabitList(todayLogs);

            } catch (error) {
                console.error('Error loading app:', error);
                habitListContainer.innerHTML = `<p class="text-red-600 text-center">Error: Could not connect to backend. Is it running?</p>`;
                motivationQuote.textContent = "Could not load data. Please refresh.";
                characterImg.style.display = 'none'; // Hide image on error
            }
        }

        /**
         * Fetches data for the Calendar & Stats view. (No changes needed)
         */
        async function fetchCalendarAndStats() {
            calendarLoader.style.display = 'block';
            calendarDaysGrid.innerHTML = '';
            try {
                const [stats, logs] = await Promise.all([
                    fetchApi('/get_stats'),
                    fetchApi('/get_logs')
                ]);
                allHabitLogs = logs;
                statStreak.textContent = stats.current_streak;
                statStreakEmoji.textContent = stats.streak_emoji;
                statTotalDays.textContent = stats.total_days;
                statTotalHabits.textContent = stats.total_habits_completed;
                statBestHabit.textContent = stats.best_habit.split(' ')[0];
                renderCalendar();
            } catch (error) {
                console.error('Error fetching calendar/stats:', error);
                calendarDaysGrid.innerHTML = `<p class="text-red-600 text-center col-span-7">Error loading calendar data.</p>`;
            } finally {
                calendarLoader.style.display = 'none';
            }
        }
        
        /**
         * Fetches stats for a friend. (No changes needed)
         */
        async function searchFriend() {
            const friendId = friendIdInput.value.trim();
            if (!friendId) return alert('Please enter a friend ID.');
            friendStatsDisplay.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch(`${BACKEND_URL}/get_friend_stats?userId=${friendId}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Friend not found');
                }
                const stats = await response.json();
                friendStatsDisplay.innerHTML = `
                    <div class="flex justify-around items-center w-full">
                        <div class="text-center">
                            <span class="text-5xl">${stats.streak_emoji}</span>
                        </div>
                        <div class="text-left">
                            <p class="text-lg text-gray-800">
                                <span class="font-bold text-blue-600">${stats.current_streak}</span> day streak
                            </p>
                            <p class="text-lg text-gray-800">
                                <span class="font-bold">${stats.total_days}</span> total days logged
                            </p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching friend stats:', error);
                friendStatsDisplay.innerHTML = `<p class="text-red-600 italic">Error: ${error.message}. Please check the ID.</p>`;
            }
        }
        
        // --- Data Posting ---

        /**
         * Sends logs and updates motivation/character image.
         */
        async function logHabits() {
            const completedHabits = [];
            document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
                if (checkbox.checked) completedHabits.push(checkbox.getAttribute('data-habit-name'));
            });
            statusLabel.textContent = 'Logging...';
            statusLabel.className = 'text-center mt-4 h-6 text-lg text-gray-500';
            try {
                // Log the habits
                await fetchApi('/log', { method: 'POST', body: JSON.stringify({ habits: completedHabits }) });
                
                statusLabel.textContent = 'Logged successfully!';
                statusLabel.className = 'text-center mt-4 h-6 text-lg text-green-600';
                
                // After logging, fetch BOTH motivation AND stats to update text and image
                const [motivationData, stats] = await Promise.all([
                    fetchApi('/get_motivation'),
                    fetchApi('/get_stats')
                ]);
                motivationQuote.textContent = motivationData.message;
                const emoji = stats.streak_emoji || 'default';
                characterImg.src = CHARACTER_IMAGES[emoji] || CHARACTER_IMAGES['default'];

            } catch (error) {
                console.error('Error logging habits:', error);
                statusLabel.textContent = 'Error: Backend is offline.';
                statusLabel.className = 'text-center mt-4 h-6 text-lg text-red-600';
            }
            setTimeout(() => { statusLabel.textContent = ''; }, 3000);
        }

        // --- Other functions (addHabit, deleteHabit, renderHabitList, renderCalendar, toggleView, copyUserId) ---
        // (No changes needed in these functions)
        async function addHabit() {
            const habitName = newHabitInput.value.trim();
            if (!habitName) return;
            try {
                userHabits = await fetchApi('/add_habit', { method: 'POST', body: JSON.stringify({ name: habitName }) });
                renderHabitList([]);
                newHabitInput.value = '';
            } catch (error) {
                console.error('Error adding habit:', error);
                alert(`Error: ${error.message}`);
            }
        }
        async function deleteHabit(habitId) {
            if (!confirm('Are you sure you want to delete this habit?')) return;
            try {
                userHabits = await fetchApi('/delete_habit', { method: 'POST', body: JSON.stringify({ id: habitId }) });
                renderHabitList([]);
            } catch (error) {
                console.error('Error deleting habit:', error);
                alert(`Error: ${error.message}`);
            }
        }
        function renderHabitList(todayLogs) {
            habitListContainer.innerHTML = '';
            if (userHabits.length === 0) {
                 habitListContainer.innerHTML = `<p class="text-gray-500 text-center">No habits added yet. Add one below!</p>`;
                 return;
            }
            userHabits.forEach(habit => {
                const isChecked = todayLogs.includes(habit.name);
                const habitElement = document.createElement('label');
                habitElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm cursor-pointer transition-all hover:shadow-md';
                let deleteButtonHTML = '';
                if (habit.is_deletable) {
                    deleteButtonHTML = `<button data-habit-id="${habit.id}" class="delete-habit-btn text-red-400 font-bold text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100">&times;</button>`;
                }
                habitElement.innerHTML = `
                    <span class="text-lg text-gray-800">${habit.name}</span>
                    <div class="flex items-center gap-2">
                        ${deleteButtonHTML}
                        <input type="checkbox" data-habit-name="${habit.name}" class="custom-checkbox habit-checkbox appearance-none w-6 h-6 border-2 border-gray-300 rounded-md transition-all" ${isChecked ? 'checked' : ''}>
                    </div>
                `;
                habitListContainer.appendChild(habitElement);
            });
            document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    deleteHabit(e.target.getAttribute('data-habit-id'));
                });
            });
        }
        function renderCalendar() {
            const today = new Date(); const month = today.getMonth(); const year = today.getFullYear();
            calendarMonthYear.textContent = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarDaysGrid.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarDaysGrid.appendChild(document.createElement('div'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div'); dayDiv.className = 'w-10 h-10 flex items-center justify-center rounded-full'; dayDiv.textContent = day;
                const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (allHabitLogs[dayString] && allHabitLogs[dayString].length > 0) dayDiv.classList.add('bg-green-200', 'text-green-800', 'font-bold');
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayDiv.classList.add(allHabitLogs[dayString] ? 'bg-green-600' : 'bg-blue-600', 'text-white');
                calendarDaysGrid.appendChild(dayDiv);
            }
        }
        function toggleView(viewToShow) {
            logView.style.display = 'none'; calendarView.style.display = 'none'; friendView.style.display = 'none';
            showLogBtn.className = 'w-1/3 py-2 text-center font-semibold tab-inactive rounded-md';
            showCalendarBtn.className = 'w-1/3 py-2 text-center font-semibold tab-inactive rounded-md';
            showFriendBtn.className = 'w-1/3 py-2 text-center font-semibold tab-inactive rounded-md';
            if (viewToShow === 'log') {
                logView.style.display = 'block'; showLogBtn.className = 'w-1/3 py-2 text-center font-semibold tab-active rounded-md'; subtitle.textContent = 'Log your daily habits';
            } else if (viewToShow === 'calendar') {
                calendarView.style.display = 'block'; showCalendarBtn.className = 'w-1/3 py-2 text-center font-semibold tab-active rounded-md'; subtitle.textContent = 'Your progress & stats'; fetchCalendarAndStats();
            } else if (viewToShow === 'friend') {
                friendView.style.display = 'block'; showFriendBtn.className = 'w-1/3 py-2 text-center font-semibold tab-active rounded-md'; subtitle.textContent = 'Check on a friend'; yourUserIdInput.value = userId;
            }
        }
        function copyUserId() {
            yourUserIdInput.select(); document.execCommand('copy'); copyIdBtn.textContent = 'Copied!';
            setTimeout(() => { copyIdBtn.textContent = 'Copy'; }, 2000);
        }

        // --- Event Listeners ---
        logButton.addEventListener('click', logHabits);
        addHabitBtn.addEventListener('click', addHabit);
        showLogBtn.addEventListener('click', () => toggleView('log'));
        showCalendarBtn.addEventListener('click', () => toggleView('calendar'));
        showFriendBtn.addEventListener('click', () => toggleView('friend'));
        copyIdBtn.addEventListener('click', copyUserId);
        searchFriendBtn.addEventListener('click', searchFriend);

        // --- Initial Load ---
        loadApp();

    </script>

</body>
</html>
